<!DOCTYPE html>

<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>ã€ŒUnmutedï¼šã€</title>

    <style>
        body {
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family:"Noto Sans", "å¾®è»Ÿæ­£é»‘é«”",sans-serif;
            
            background-repeat: no-repeat;
            background-size: 110% 110%;
            position: relative;
            background-color: rgba(126, 126, 126, 0.835);
        }

        .glow-text {
            font-size: 76px; 
            transform: translateX(-7%);
            color: #e4f1ff;
            position:absolute;
            bottom:10%;
            height: 100%;
            text-shadow:
                0 0 2px rgba(255, 255, 255, 0.921),
                0 0 22px rgba(255, 255, 255, 0.529),
                0 0 25px rgba(255, 255, 255, 0.436),
                0 0 30px rgba(255, 255, 255, 0.427);
        }
        .glow-texth2 {
            font-size: 30px; 
            color: #e4f1ff;
            text-shadow:
                0 0 6px rgba(255, 255, 255, 0.921),
                0 0 22px rgba(255, 255, 255, 0.529),
                0 0 25px rgba(255, 255, 255, 0.436),
                0 0 30px rgba(255, 255, 255, 0.427);
        }
        .glow-textt {
            color: #e4f1ff;
            text-shadow:
                0 0 22px rgba(255, 255, 255, 0.529),
                0 0 25px rgba(255, 255, 255, 0.436),
                0 0 30px rgba(255, 255, 255, 0.427);
        }
        .gradient {
            background: #323C4A;
            background-image: linear-gradient(#97ADCF, #E3D9BE);
        }

        .container {
            width: 100%;
            height: 100%;
            position: relative;
            text-align: center;
            background: rgba(0, 0, 0, 0.237);
            backdrop-filter: blur(6px);
            border-radius: 2px;
            padding: 32px 24px;
        }

        textarea {
            align-items: center;
            height: 80px;
            width:360px;
            resize: none;
            padding: 10px;
            font-size: 14px;
            color: #e8ffff;
            background: none;
            box-shadow:
        0 0 1px rgba(255, 255, 255, 0.86),
        0 0 12px rgba(226, 242, 255, 0.328),
        inset 0 0 8px rgba(255,255,255,0.08);
            border: none;
            border-radius: 4px;
            outline: none;
            }
        textarea::placeholder {
            color: rgba(232, 255, 255, 0.483);
            }
        button {
            margin-top: 12px;
            padding: 8px 20px;
            font-size: 14px;
            cursor: pointer;
        }
        .glass-button {
            background: rgba(255, 255, 255, 0.1);  /* åŠé€æ˜ç™½è‰² */
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            backdrop-filter: blur(5px);
            padding: 8px 20px;
            font-size: 14px;
            color: #e8ffff;
            cursor: pointer;
        }
        .interactive-btn {
            transition:
                transform 0.18s cubic-bezier(0.34, 1.56, 0.64, 1),
                filter 0.18s ease;
            will-change: transform;
        }
        .interactive-btn:hover {
            transform: scale(1.06);
            opacity: 0.8;
            filter: brightness(1.2);
        }
        .interactive-btn:active {
            transform: scale(1) translateY(1px);
        }
        #loading {
            margin-top: 20px;
        }
        audio {
            width: 100%;
            margin-top: 16px;
        }
        #input-view {
            position: relative;
        }
        .back-to-start {
            position: absolute;
            top: 0;
            left: 0;
            padding: 4px 10px;
            font-size: 12px;
            margin: 0;
        }
        #noise {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 999;

            opacity: 0.12;
            mix-blend-mode: overlay;
        }
        .scene {
            position: absolute;
            inset: 0;
            overflow: hidden; 
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            width: 100%; 
            height: 100%;
            
        }
        .hidden {
            display: none;
            opacity: 0;
        }
        .scene:not(.hidden) {
            pointer-events: auto;
        }
        .scene-content {
            transition:
                transform 0.8s cubic-bezier(0.02, 1, 0.56, 1),
                opacity 0.6s ease;
            transform-origin: center;
            transform-style: preserve-3d;
            width:500px
        }
        .scene.exiting .scene-content {
            transform: scale(1.7) translateZ(20px);
            opacity: 0;
        }
        /* é€²å…¥å‹•ç•«æœ€çµ‚ç‹€æ…‹ */
        .scene.entered .scene-content {
            transform: scale(1);
            opacity: 1;
        }
        .scene.entering .scene-content {
            transform: scale(1.7);
            opacity: 0;
        }
        .intro-wrapper {
            position: absolute;
            width: 80%;
            height: 500px;
        }
        /* ç»ç’ƒå°è©±æ¡† */
        .dialog {
            position: absolute;
            max-width: 420px;
            height: 18px;
            
            padding: 14px 18px;
            border: none;
            border-radius: 25px;
            box-shadow:
        0 0 1px rgba(255, 255, 255, 0.86),
        0 0 12px rgba(200, 230, 255, 0.328),
        inset 0 0 8px rgba(255,255,255,0.08);
            background: none;
            color:#ffffff;
            font-size: 15px;
            line-height: 1.2;

            opacity: 0;
            transform: translateY(10px) scale(0.95);
            transition: opacity 0.6s ease, transform 0.6s ease; 
        }

        .dialog-1 { top: 18%; left: 30%; animation: float1 5s ease-in-out infinite;}
        .dialog-2 { top: 30%; left: 25%; animation: float2 5.5s ease-in-out infinite;}
        .dialog-3 { top: 42%; left: 37%; animation: float3 4s ease-in-out infinite;}
        .dialog-4 { top: 54%; left: 32%; animation: float4 6s ease-in-out infinite;}
        .dialog-5 { top: 66%; left: 50%; animation: float5 4s ease-in-out infinite;}
        /* å‡ºç¾ç‹€æ…‹ */
        .dialog.show {
            opacity: 1;
            transform: translateY(0) scale(1);
        
        }
        .skip-hint {
            position: absolute;
            top: 90px;
            right: 28px;
            font-size: 13px;
            color: #ffffff93;
        }
        .continue-hint {
            position: absolute;
            text-align: center;
            bottom: 50px;
            width: 100%;
            
            font-size: 14px;
            color: #ffffff;
            letter-spacing: 2px;
            animation: hintPulse 2.5s ease-in-out infinite;
        }
        @keyframes float1 {
            0%   { transform: translate(0, 0) scale(1); }
            50%  { transform: translate(3px, -4px) scale(1.01); }
            100% { transform: translate(0, 0) scale(1); }
        }
        @keyframes float2 {
            0%   { transform: translate(0, 0) scale(1); }
            50%  { transform: translate(-2px, 4px) scale(1.01); }
            100% { transform: translate(0, 0) scale(1); }
        }
        @keyframes float3 {
            0%   { transform: translate(0, 0) scale(1); }
            50%  { transform: translate(-3px, 2px) scale(1.01);}
            100% { transform: translate(0, 0) scale(1); }
        }
        @keyframes float4 {
            0%   { transform: translate(0, 0) scale(1); }
            50%  { transform: translate(4px, -3px) scale(1.01); }
            100% { transform: translate(0, 0) scale(1); }
        }
        @keyframes float5 {
            0%   { transform: translate(0, 0) scale(1); }
            50%  { transform: translate(3px, 1px) scale(1.01); }
            100% { transform: translate(0, 0) scale(1); }
        }
        .start-hint {
            position: relative;
            height:100%;
            top: 100px;
            font-size: 14px;
            letter-spacing: 0.15em;
            color:#ffffff;
            opacity: 0.9;
            animation: hintPulse 2.5s ease-in-out infinite;
        }
        @keyframes hintPulse {
            0%   { opacity: 0.4; }
            50%  { opacity: 1; }
            100% { opacity: 0.4; }
        } 
        .back-hint {
            position: absolute;
            top: 33px;
            left: -82px;
            font-size: 13px;
            color: #ffffff93;
        }
        .input-hint {
            position: absolute;
            text-align: center;
            bottom: -60px;
            width: 100%;
            
            font-size: 14px;
            color: #ffffff;
            letter-spacing: 2px;
            animation: hintPulse 2.5s ease-in-out infinite;
        }
        #wave-canvas {
            position: absolute;
            scale: 4;
            transform: scaleY(5);
            left:-5px;
            bottom: 30px;
            width: 100%;
            margin-top: 1000px;
            filter:
                drop-shadow(0 0 6px rgba(200, 230, 255, 0.571))
                drop-shadow(0 0 12px rgba(200, 230, 255, 0.306));
            opacity: 0.9;
        }
        .home-hint {
            position: absolute;
            bottom: -180px;
            right:-53px;
            font-size: 14px;
            color: #ffffff;
            animation: hintPulse 2.5s ease-in-out infinite;
        }
        .play-hint {
            position: absolute;
            bottom: -220px;
            width:100%;
            font-size: 14px;
            color: #ffffff;
        }
        .again-hint {
            position: absolute;
            bottom: -180px;
            left: -53px;
            font-size: 14px;
            color: #ffffff;
            animation: hintPulse 2.5s ease-in-out infinite;
        }
        .countdown-hint {
            position: absolute;
            bottom: -180px;
            width:100%;
            font-size: 14px;
            color: #ffffff;
        }
    </style>
</head>
<body class = "stacked-linear">

<div class="container">

    <!-- ğŸŒ± èµ·å§‹ç•«é¢ -->
    <div id="start-view" class="scene hidden">
        <div class="scene-content">
            <h1 class="glow-text">ã€ŒUnmutedï¼šã€</h1>
            <div class="glow-textt start-hint" >ï¼é»æ“Šç©ºç™½éµé–‹å§‹ï¼</div>
            </div>
        </div>
    <!-- ğŸŒ± æ–‡å­—ç•«é¢ -->
    <div id="intro-scene" class="scene hidden">
        <div class="scene-content intro-wrapper">
        <!-- å°è©±æ¡†å€ -->
         <!-- å³ä¸Šè§’è·³éæç¤º -->
            <div class="skip-hint hidden">â†µ Enter è·³é</div>
            <div class="dialog dialog-1 glow-textt">
            ä½ å¥½ï¼Œæ­¡è¿ä¾†åˆ°ã€ŒUnmutedï¼šã€ã€‚
            </div>
            <div class="dialog dialog-2 glow-textt">
            æœ€è¿‘éå¾—å¦‚ä½•å‘¢ï¼Ÿ
            </div>
            <div class="dialog dialog-3 glow-textt">
            å¦‚æœæœ‰é›£ä»¥èªªå‡ºå£çš„è©±ï¼Œ
            </div>
            <div class="dialog dialog-4 glow-textt">
            å¯ä»¥å‘Šè¨´ã€ŒUnmutedï¼šã€ï¼Œå°‡è©±èªè½‰è®Šç‚ºæ¨‚éŸ³ï¼Œ
            </div>
            <div class="dialog dialog-5 glow-textt">
            ä½œç‚ºè¢«ç†è§£ä¹‹å¤–çš„ï¼Œå¦ä¸€ç¨®è¡¨é”ã€‚
            </div>
        <!-- åº•éƒ¨æç¤º -->
            <div class="continue-hint hidden">
            ï¼ æŒ‰ä¸‹ç©ºç™½éµç¹¼çºŒ ï¼
            </div>
        </div>
    </div>
    <!-- âœï¸ è¼¸å…¥ç•«é¢ -->
    <div id="input-view" class="scene hidden">
        <div class="scene-content">
            <div class="back-hint">esc è¿”å›ä¸»ç•«é¢</div>
            <h2 class="glow-textt">ä»Šå¤©æƒ³èªªä»€éº¼å‘¢ï¼Ÿ</h2>
            <textarea 
            id="sentence" 
            maxlength="200"
            placeholder="éš¨æ„å¯«é»æ±è¥¿å§"
            required></textarea>
            <br>
            <div class = "input-hint">ï¼æŒ‰ä¸‹Enteréµé€å‡ºï¼</div>
        </div>
    </div>
    <!-- â³ Loading -->
    <div id="loading" class="scene hidden">
        <div class="scene-content">
        <p class = "glow-texth2">éŸ³æ¨‚ç”Ÿæˆä¸­â€¦</p>
        </div>
    </div>

    <!-- ğŸ§ æ’­æ”¾ç•«é¢ -->
    <div id="player-view" class="scene hidden">
        <div class="scene-content">
        <audio id="audio-player"></audio>
        <canvas id="wave-canvas"></canvas>
        <div style="margin-top: 6px;">
            <div class="again-hint glow-textt">ï¼¦éµ / å†æ¬¡è¼¸å…¥</div>
            <div class="home-hint glow-textt">ç©ºç™½éµ / è¿”å›ä¸»ç•«é¢</div>
            <div class="play-hint" id="replay-countdown"></div>
            <div class="countdown-hint" id="idle-countdown"></div>
        </div>  
        </div>
    </div>
</div>
<canvas id="noise"></canvas>
<script>
    const startBtn = document.getElementById('start-btn');
    const submitBtn = document.getElementById('submit-btn');
    const backBtn = document.getElementById('back-btn');
    const backToStartBtn = document.getElementById('back-to-start-btn');

    const sentenceInput = document.getElementById('sentence');
    const audioPlayer = document.getElementById('audio-player');

    const startView = document.getElementById('start-view');
    const inputView = document.getElementById('input-view');
    const loadingView = document.getElementById('loading');
    const playerView = document.getElementById('player-view');
    const progressBar = document.getElementById('progress-bar');

    const canvas = document.getElementById('noise');
    const ctx = canvas.getContext('2d');
    const bg = document.body;
    const introScene = document.getElementById('intro-scene');
    const inputScene = document.getElementById('input-view'); // ä½ åŸæœ¬çš„è¼¸å…¥ç•«é¢ scene
    const dialogs = introScene.querySelectorAll('.dialog');
    const continueHint = introScene.querySelector('.continue-hint');
    const skipHint = introScene.querySelector('.skip-hint');    
    let introFinished = false;
    let introSkipped = false;
    let isGenerating = false;
    let audioCtx, analyser, source;
    let waveCanvas, waveCtx;
    let waveData;
    let smoothedValues = [];
    let replayTimer = null;
    let replayCountdown = 5;
    let idleTimer = null;
    let idleCountdown = 60;
    let isPlaying = false;
    let isDrawingWave = false;

function initWaveform() {
    if (audioCtx) return;

    audioCtx = new AudioContext();
    source = audioCtx.createMediaElementSource(audioPlayer);
    analyser = audioCtx.createAnalyser();

    analyser.fftSize = 512;
    waveData = new Uint8Array(analyser.frequencyBinCount);

    source.connect(analyser);
    analyser.connect(audioCtx.destination);

    waveCanvas = document.getElementById('wave-canvas');
    waveCtx = waveCanvas.getContext('2d');

    resizeWaveCanvas();
}
function resizeWaveCanvas() {
    waveCanvas.width = waveCanvas.offsetWidth * window.devicePixelRatio;
    waveCanvas.height = waveCanvas.offsetHeight * window.devicePixelRatio;
    waveCtx.scale(window.devicePixelRatio, window.devicePixelRatio);
}
window.addEventListener('resize', resizeWaveCanvas);

function drawWave() {
    if (!analyser || !isDrawingWave) return;
    analyser.getByteTimeDomainData(waveData);
    const w = waveCanvas.width / window.devicePixelRatio;
    const h = waveCanvas.height / window.devicePixelRatio;
    const centerY = h / 2;
    waveCtx.clearRect(0, 0, w, h);
    const barCount = 160;
    const barWidth = w / barCount;
    // åˆå§‹åŒ–å¹³æ»‘å€¼
    if (smoothedValues.length !== barCount) {
        smoothedValues = Array(barCount).fill(0);
    }
    for (let i = 0; i < barCount; i++) {
        const dataIndex = Math.floor(i / barCount * waveData.length);
        let v = (waveData[dataIndex] - 128) / 128;
        // å¹³æ»‘è™•ç† (é€Ÿåº¦è®Šæ…¢)
        smoothedValues[i] = smoothedValues[i] * 0.7 + v * 0.3;
        // æ”¾å¤§æ³¢å¹…
        let amplitude = smoothedValues[i] * 70 * (0.5 + Math.sin(i * 0.3 + Date.now() * 0.002) * 0.5);
        // å¤šå±¤ç·šå¢åŠ åšåº¦
        for (let layer = 0; layer < 3; layer++) {
            waveCtx.strokeStyle = `rgba(245, 255, 255, ${0.25 + Math.abs(smoothedValues[i]) * 0.4 * (1 - layer * 0.3)})`;
            waveCtx.lineWidth = 0.3 + layer; // ç·šæ¢åŠ ç²—
            waveCtx.beginPath();
            waveCtx.moveTo(i * barWidth, centerY - amplitude * (1 - layer * 0.3));
            waveCtx.lineTo(i * barWidth, centerY + amplitude * (1 - layer * 0.3));
            waveCtx.stroke();
        }
    }
    requestAnimationFrame(drawWave);
}

    // â–¶ï¸ èµ·å§‹ç•«é¢ â†’ è¼¸å…¥ç•«é¢
    startView.classList.remove('hidden');
    function resize() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        drawNoise();
    }

    function drawNoise() {
        const imageData = ctx.createImageData(canvas.width, canvas.height);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const value = Math.random() * 255;
            data[i]     = 0;      // R
            data[i + 1] = 0;      // G
            data[i + 2] = 0;      // B
            data[i + 3] = value;  // Alpha â†’ é¡†ç²’å¼·å¼±
        }
            ctx.putImageData(imageData, 0, 0);
    }
    resize();
    window.addEventListener('resize', resize);
function random(min, max) {
    return Math.random() * (max - min) + min;
}

// æ¯ä¸€å±¤çš„ã€Œç›®å‰ä½ç½®ã€èˆ‡ã€Œç§»å‹•æ–¹å‘ã€
const layers = [
    { x: 6.7, y: 6.7, dx: random(1, 2), dy:random(1, 2),
        rgb: '221, 178, 250',
        alpha: 0.5,
        radius: '90%'
    },
    { x: 100, y: 100, dx: random(-2, -1), dy:random(1, 2),
        rgb: '155, 202, 232',
        alpha: 0.8,
        radius: '90%'
    },
    { x: 65, y: 0, dx: random(1, 2), dy:random(-1,-2),
        rgb: '28, 51, 79',
        alpha: 0.8,
        radius: '70%'
    },
    { x: 0, y: 75, dx: random(1,2), dy:random(-1, -2),
        rgb: '24, 34, 47',
        alpha: 0.8,
        radius: '70%'
    }
];

// å¯æ´»å‹•çš„å€é–“
const bounds = {
    xMin: 0,
    xMax: 100,
    yMin: 0,
    yMax: 100
};
function updateBackground() {
    // æ›´æ–°ä½ç½®
    layers.forEach(layer => {
        layer.x += layer.dx;
        layer.y += layer.dy;

        if (layer.x <= 0 || layer.x >= 100) layer.dx *= -1;
        if (layer.y <= 0 || layer.y >= 100) layer.dy *= -1;
    });

    // çµ„ radial-gradient å­—ä¸²
    const gradients = layers.map(layer => `
        radial-gradient(
            circle at ${layer.x.toFixed(2)}% ${layer.y.toFixed(2)}%,
            rgba(${layer.rgb}, ${layer.alpha}),
            rgba(255,255,255,0) ${layer.radius}
        )
        `).join(',');

    // å¥—åˆ° body
    bg.style.backgroundImage = gradients;
}
setInterval( updateBackground, 1000 / 8);

audioPlayer.addEventListener('timeupdate', () => {
    if (!audioPlayer.duration) return;
    const progress =
        (audioPlayer.currentTime / audioPlayer.duration) * 100;
    progressBar.value = progress;
});

function switchScene(from, to) {
    from.classList.remove('hidden');
    from.classList.add('exiting'); 
    setTimeout(() => { 
    
    from.classList.add('hidden');
    from.classList.remove('exiting');
    to.classList.add('entering'); 
    to.classList.remove('hidden');  
    
        requestAnimationFrame(() => {   
            to.classList.add('entered');
        });
        setTimeout(() => {
            to.classList.remove('entering');
            to.classList.remove('entered');
        }, 200);
    }, 800); // âš ï¸ è¦è·Ÿ CSS transition æ™‚é–“ä¸€è‡´
}
function resetIntro() {
    // 1ï¸âƒ£ é‡ç½®æ‰€æœ‰å°è©±æ¡†
    dialogs.forEach(dialog => {
        dialog.classList.remove('show');
    });

    // 2ï¸âƒ£ éš±è—åº•éƒ¨æç¤º
    continueHint.classList.add('hidden');

    // 3ï¸âƒ£ é‡ç½®ç‹€æ…‹ flag
    introFinished = false;
    introSkipped = false;

    // 4ï¸âƒ£ æ¸…æ‰ introScene ä¸Šæ®˜ç•™çš„å‹•ç•« class
    introScene.classList.remove('entering', 'entered', 'exiting');
}
const TRANSITION_TIME = 600; // è¦å’Œ switchScene çš„æ™‚é–“ä¸€è‡´
const EXTRA_DELAY = 1000;    // ä½ è¦çš„ 1 ç§’å»¶é²
function startIntro() {
    // å…ˆåˆ‡å ´ï¼ˆè·‘ exiting / entering å‹•ç•«ï¼‰
    switchScene(startView, introScene);

    // â­ ç­‰è½‰å ´å‹•ç•«è·‘å®Œ + 1 ç§’ç·©è¡
    

    setTimeout(() => {

        dialogs.forEach((dialog, index) => {

            setTimeout(() => {
            skipHint.classList.remove('hidden');
        }, 1200);
            setTimeout(() => {
                if (introSkipped) return;
                dialog.classList.add('show');
                }, 
            index * 1700);
        });

        // å…¨éƒ¨å°è©±æ¡†å‡ºç¾å¾Œï¼Œæ‰é¡¯ç¤ºã€Œç©ºç™½éµç¹¼çºŒã€
        setTimeout(() => {
            if (introSkipped) return;
            continueHint.classList.remove('hidden');
            introFinished = true;
        }, dialogs.length * 1700 + 500);

    }, TRANSITION_TIME + EXTRA_DELAY);
}
async function generateMusic() {
    if (isGenerating) return;
    isGenerating = true;
    const sentence = sentenceInput.value.trim();
        if (!sentence) {
            alert('è«‹è¼¸å…¥æ–‡å­—');
            isGenerating = false;
            return;
        }
        switchScene(inputView, loadingView);
        try {
            const response = await fetch('/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ sentence })
            });
            if (!response.ok) {
                throw new Error('ç”Ÿæˆå¤±æ•—');
            }
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            audioPlayer.src = url;
            await new Promise(resolve => setTimeout(resolve, 2000));
            switchScene(loadingView, playerView);
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            initWaveform();
            audioCtx.resume();
            isDrawingWave = true;
            await audioPlayer.play();
            drawWave();
            startIdleCountdown();
            sentenceInput.value = '';

        } catch (err) {
            alert('ç”ŸæˆéŸ³æ¨‚å¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡');
            switchScene(loadingView, inputView);
            }finally {
        isGenerating = false;
        }
        audioPlayer.addEventListener('play', () => {
            isPlaying = true;
            clearInterval(replayTimer);
            document.getElementById('replay-countdown').textContent = '';
        });

        audioPlayer.addEventListener('ended', () => {
            isPlaying = false;
            startReplayCountdown();
        });
}
function startReplayCountdown() {
    replayCountdown = 5;
    const el = document.getElementById('replay-countdown');
    el.textContent = `${replayCountdown} ç§’å¾Œå†æ¬¡æ’­æ”¾`;
    replayTimer = setInterval(() => {
        if (isPlaying) {
            clearInterval(replayTimer);
            el.textContent = '';
            return;
        }
        replayCountdown--;
        if (replayCountdown <= 0) {
            clearInterval(replayTimer);
            el.textContent = '';
            audioPlayer.currentTime = 0;
            audioPlayer.play();
        } else {
            el.textContent = `${replayCountdown} ç§’å¾Œå†æ¬¡æ’­æ”¾`;
        }
    }, 1000);
}
function startIdleCountdown() {
    clearInterval(idleTimer);
    idleCountdown = 60;
    const el = document.getElementById('idle-countdown');
    el.textContent = `${idleCountdown} ç§’å¾Œè‡ªå‹•è¿”å›`;

    idleTimer = setInterval(() => {
        idleCountdown--;

        if (idleCountdown <= 0) {
            clearInterval(idleTimer);
            audioPlayer.pause();
            audioPlayer.src = '';
            switchScene(playerView, startView);
        } else {
            el.textContent = `${idleCountdown} ç§’å¾Œè‡ªå‹•è¿”å›`;
        }
    }, 1000);
}
document.addEventListener('keydown', (e) => {
    if (e.repeat) return;
    // Enterï¼šéš¨æ™‚è·³é
    if (e.code === 'Enter' ){
        if (!introFinished || !introScene.classList.contains('hidden')) {
            e.preventDefault();
            introSkipped = true;
            introFinished = true;
            switchScene(introScene, inputView);
            return; 
        }
        //ç”ŸæˆéŸ³æ¨‚    
        if (!inputView.classList.contains('hidden')) {
            e.preventDefault();
            generateMusic();
            return;   
        }
    }
    if (e.code === 'Escape') {
        if (!inputView.classList.contains('hidden')) {
            e.preventDefault();
            sentenceInput.value = '';
            switchScene(inputView, startView);
            return; 
        }
    }
    if (e.key.toLowerCase() === 'f' ){
        if(!playerView.classList.contains('hidden')) {
        e.preventDefault();
        // ğŸ›‘ åœæ­¢éŸ³æ¨‚
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
             // ğŸ›‘ åœæ­¢æ³¢å½¢ç¹ªè£½
            isDrawingWave = false;
            if (waveCtx && waveCanvas) {
                waveCtx.clearRect(
                  0,
                  0,
                 waveCanvas.width,
                 waveCanvas.height
                );
            }
            // ğŸ›‘ æ¸…é™¤æ‰€æœ‰å€’æ•¸è¨ˆæ™‚
            if (replayTimer) {
                clearTimeout(replayTimer);
                replayTimer = null;
            }
            if (idleTimer) {
                clearInterval(idleTimer);
                idleTimer = null;
            }
        switchScene(playerView, inputView );
        return; 
        }
    }
    if (e.code === 'Space') {
    e.preventDefault();
    // åªæœ‰åœ¨èµ·å§‹ç•«é¢æ‰èƒ½é–‹å§‹
        if (!startView.classList.contains('hidden')) {
            resetIntro();   // â­ é‡ç½®å‰å°å‹•ç•«
            startIntro();   // â­ åˆ‡æ›åˆ°å‰å°ç•«é¢
            return;
        }
    // å‰å°ç•«é¢ä¸­ï¼Œä¸”å‹•ç•«å®Œæˆå¾Œï¼Œç©ºç™½éµæ‰ç¹¼çºŒ
        if (!introScene.classList.contains('hidden') && introFinished) {
            
            switchScene(introScene, inputView);
            return;
        }
    
        if (!playerView.classList.contains('hidden')) {
            audioPlayer.pause();
            sentenceInput.value = '';
            audioPlayer.currentTime = 0;
             // ğŸ›‘ åœæ­¢æ³¢å½¢ç¹ªè£½
            isDrawingWave = false;
            if (waveCtx && waveCanvas) {
                waveCtx.clearRect(
                  0,
                  0,
                 waveCanvas.width,
                 waveCanvas.height
                );
            }
            // ğŸ›‘ æ¸…é™¤æ‰€æœ‰å€’æ•¸è¨ˆæ™‚
            if (replayTimer) {
                clearTimeout(replayTimer);
                replayTimer = null;
            }
            if (idleTimer) {
                clearInterval(idleTimer);
                idleTimer = null;
            }
            switchScene(playerView, startView);
            return;
        }
    }
});
</script>
</body>
</html>